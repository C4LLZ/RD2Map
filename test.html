<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDR2 Interactive Map</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rye&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <style>
    :root {
      --bg: #0f0f11;
      --panel: #161619;
      --muted: #a9956b;
      --gold: #d4af37;
      --gold-2: #c59d2f;
      --gold-3: #9e7d1f;
      --text: #e9e3d5;
      --subtext: #c5bdac;
      --accent: #6b4e2e;
      --danger: #d36161;
      --ok: #64c39a;
      --shadow: rgba(0,0,0,.45);
    }

    * { box-sizing: border-box; }
    html, body, #app { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: Cinzel, serif; }

    .frame-top, .frame-bottom {
      position: fixed; left: 0; right: 0; height: 8px; pointer-events: none; z-index: 9999;
      background: linear-gradient(90deg, transparent, var(--gold) 15%, var(--gold-2) 50%, var(--gold) 85%, transparent);
      filter: drop-shadow(0 1px 0 var(--gold-3));
    }
    .frame-top { top: 0; }
    .frame-bottom { bottom: 0; }

    #app { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: 56px 1fr; gap: 0; }

    header {
      grid-column: 1 / span 2; grid-row: 1;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      padding: 10px 16px; background: radial-gradient(1200px 120px at 50% 0%, rgba(212,175,55,.12), transparent 70%), var(--panel);
      border-bottom: 1px solid rgba(212,175,55,.25);
      box-shadow: 0 6px 16px var(--shadow);
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand .logo {
      width: 34px; height: 34px; border: 2px solid var(--gold); color: var(--gold);
      display: grid; place-items: center; border-radius: 6px;
      box-shadow: inset 0 0 8px rgba(212,175,55,.25), 0 2px 10px var(--shadow);
      font-family: Rye, serif; font-size: 18px; letter-spacing: 1px;
    }
    .brand h1 { margin: 0; font-size: 20px; letter-spacing: 2px; text-shadow: 0 1px 0 #000; }

    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      background: linear-gradient(180deg, rgba(212,175,55,.15), rgba(212,175,55,.05));
      border: 1px solid rgba(212,175,55,.35);
      color: var(--text);
      padding: 8px 10px; border-radius: 8px; font-family: Cinzel, serif; font-size: 12px;
      cursor: pointer; box-shadow: inset 0 0 0 1px rgba(0,0,0,.35), 0 2px 6px var(--shadow);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn.ghost { background: transparent; }
    .btn.primary { border-color: var(--gold); color: var(--gold); }
    .btn.danger { border-color: rgba(211,97,97,.6); color: var(--danger); }

    aside {
      grid-column: 1; grid-row: 2;
      border-right: 1px solid rgba(212,175,55,.25);
      background: linear-gradient(180deg, rgba(212,175,55,.04), transparent 20%), var(--panel);
      overflow: hidden; display: grid; grid-template-rows: auto auto 1fr auto; min-width: 0;
    }
    /* Avoid horizontal overflow, allow content to wrap */
    aside .section, aside .footer { min-width: 0; }
    .controls { flex-wrap: wrap; }

    .section { padding: 12px 14px; border-bottom: 1px solid rgba(212,175,55,.15); }
    .section h2 { margin: 0 0 8px; font-size: 14px; color: var(--gold); letter-spacing: 1px; }

    .field { display: grid; gap: 6px; margin-bottom: 10px; }
    label { font-size: 11px; color: var(--subtext); }
    input[type="text"], select, textarea, input[type="number"] {
      width: 100%; background: #0c0c0e; color: var(--text); border: 1px solid rgba(212,175,55,.2);
      border-radius: 8px; padding: 8px 10px; font-family: Cinzel, serif; font-size: 12px;
      outline: none;
    }

    .pill-row { display:flex; flex-wrap:wrap; gap:6px; }
    .pill {
      font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(212,175,55,.35);
      background: rgba(212,175,55,.08); color: var(--subtext); cursor: pointer;
    }
    .pill.active { color: var(--gold); border-color: var(--gold); background: rgba(212,175,55,.12); }

    .list { overflow: auto; padding: 10px 0 90px; }
    .item { padding: 10px 14px; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .item + .item { border-top: 1px dashed rgba(212,175,55,.18); }
    .item .meta { display:flex; align-items:center; gap:8px; min-width: 0; }
    .dot { width: 10px; height: 10px; border-radius: 999px; border: 1px solid #0003; box-shadow: 0 1px 0 #000; }
    .title { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cat { font-size: 10px; color: var(--subtext); }

    .footer { position: relative; display:flex; gap:8px; padding: 10px 14px; background: #121215; border-top: 1px solid rgba(212,175,55,.15); flex-wrap: wrap; }
    .footer input[type="file"]{ display:none; }

    #map { grid-column: 2; grid-row: 2; height: 100%; width: 100%; }

    .leaflet-control { box-shadow: 0 2px 8px var(--shadow); border: 1px solid rgba(212,175,55,.2); }
    .leaflet-bar a, .leaflet-bar a:hover { background: #0e0e10; color: var(--text); border-bottom: 1px solid rgba(212,175,55,.2); }
    /* Hide Leaflet Draw toolbar if present (we use custom buttons) */
    .leaflet-draw { display:none !important; }
    .leaflet-popup-content-wrapper { background:#0f0f11; color:var(--text); border:1px solid rgba(212,175,55,.35); border-radius: 8px; }
    .leaflet-popup-tip { background:#0f0f11; border:1px solid rgba(212,175,55,.35); }
    /* Hint the compositor for smoother pans */
    .leaflet-image-layer { will-change: transform; }

    /* Grouped list by category */
    .group { border-top: 1px solid rgba(212,175,55,.15); }
    .group:first-child { border-top: 0; }
    .group-header { display:flex; align-items:center; gap:8px; padding: 8px 12px; cursor: pointer; user-select: none; }
    .group-header:hover { background: rgba(212,175,55,.05); }
    .group-header .chev { transition: transform .15s ease; color: var(--gold); }
    .group.collapsed .group-header .chev { transform: rotate(-90deg); }
    .group-header .count { margin-left:auto; font-size:11px; color: var(--subtext); }
    .group-items { }
    .group.collapsed .group-items { display:none; }

    dialog { width: min(720px, 92vw); border: 1px solid rgba(212,175,55,.3); background:#0f0f11; color: var(--text); border-radius: 12px; }
    dialog::backdrop { background: rgba(0,0,0,.6); }
    dialog header { grid-column: unset; grid-row: unset; }
    .modal-body { padding: 14px 16px 18px; }

    @media (max-width: 992px) {
      #app { grid-template-columns: 1fr; grid-template-rows: 56px auto 1fr; }
      aside { grid-column: 1; grid-row: 2; height: 44vh; }
      #map { grid-column: 1; grid-row: 3; }
    }
  </style>
</head>
<body>
  <div class="frame-top"></div>
  <div class="frame-bottom"></div>

  <div id="app">
    <header>
      <div class="brand">
        <h1>Ranch Map</h1>
      </div>
      <div class="controls">
        <button id="btn-draw-marker" class="btn primary" title="Add marker">Marker</button>
        <button id="btn-draw-poly" class="btn primary" title="Add zone">Zone</button>
        <button id="btn-edit" class="btn" title="Edit layers">Edit</button>
        <button id="btn-stop" class="btn ghost" title="Stop drawing or editing">Stop</button>
      </div>
    </header>

    <aside>
      <div class="section">
        <h2>Category</h2>
        <div class="field">
          <div style="display:flex; gap:8px;">
            <input type="text" id="category-input" placeholder="New category" />
            <button id="add-category" class="btn">Add</button>
          </div>
        <div style=" display:flex; gap:8px; flex-wrap:wrap;">
          <button id="edit-categories" class="btn ghost">Edit Categories</button>
        </div>
        </div>
      </div>

      <div class="section">
        <h2>Visibility</h2>
        <div id="visibility-list" class="pill-row"></div>
      </div>

      <div class="section" style="padding-bottom:0;">
        <h2>Items</h2>
      </div>
      <div class="section" id="search-wrap" style="padding-top:6px;">
        <div class="field">
          <input type="text" id="search-input" placeholder="Search title, description, category" />
        </div>
      </div>
      <div id="items" class="list"></div>

      <div class="footer">
        <button id="export" class="btn">Export</button>
        <label class="btn" for="import-file">Import</label>
        <input id="import-file" type="file" accept="application/json" />
        <button id="reset" class="btn danger">Reset</button>
      </div>
    </aside>

    <div id="map"></div>
  </div>

  <dialog id="help-modal">
    <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 16px;">
      <strong>How it works</strong>
      <button class="btn" onclick="helpModal.close()">Close</button>
    </header>
    <div class="modal-body">
      <ol style="margin:0 0 12px 18px; line-height:1.6;">
        <li>Place map.png next to this HTML file.</li>
        <li>Set image width and height in pixels if different.</li>
        <li>Use Marker to drop a point. Use Zone to draw a polygon.</li>
        <li>Click an item to edit title, description, category, color.</li>
        <li>Export or import JSON. Data persists locally.</li>
      </ol>
      <p style="color:var(--subtext); font-size:12px;">This uses a static image with CRS.Simple. Coordinates are pixels.</p>
    </div>
  </dialog>

  <!-- Export modal -->
  <dialog id="export-modal">
    <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 16px;">
      <strong>Export</strong>
      <button class="btn" onclick="document.getElementById('export-modal').close()">Close</button>
    </header>
    <div class="modal-body">
      <div class="field">
        <label>What would you like to export?</label>
        <div style="display:grid; gap:6px;">
          <label style="display:flex; gap:8px; align-items:center;">
            <input type="radio" name="ex-scope" value="all" checked />
            <span>All items (with settings)</span>
          </label>
          <label style="display:flex; gap:8px; align-items:center;">
            <input type="radio" name="ex-scope" value="single" />
            <span>Single item</span>
          </label>
        </div>
      </div>
      <div class="field" id="ex-item-wrap" style="display:none;">
        <label>Choose item</label>
        <select id="ex-item"></select>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="ex-do" class="btn primary">Export</button>
        <button class="btn" onclick="document.getElementById('export-modal').close()">Cancel</button>
      </div>
    </div>
  </dialog>

  <!-- Reset confirm modal -->
  <dialog id="confirm-reset">
    <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 16px;">
      <strong>Confirm Reset</strong>
      <button class="btn" onclick="document.getElementById('confirm-reset').close()">Close</button>
    </header>
    <div class="modal-body">
      <p style="margin-top:0;">This will clear all items and restore defaults. Your changes will be lost unless exported. Continue?</p>
      <div style="display:flex; gap:8px;">
        <button id="confirm-reset-yes" class="btn danger">Reset</button>
        <button class="btn" onclick="document.getElementById('confirm-reset').close()">Cancel</button>
      </div>
    </div>
  </dialog>

  <!-- Edit categories modal -->
  <dialog id="cat-modal">
    <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 16px;">
      <strong>Edit Categories</strong>
      <button class="btn" onclick="document.getElementById('cat-modal').close()">Close</button>
    </header>
    <div class="modal-body">
      <div id="cat-list" class="field"></div>
      <div class="field">
        <label>Move items to</label>
        <select id="cat-move-target"></select>
      </div>
      <p style="color:var(--subtext); font-size:12px;">Deleting a category will move its items to the selected target.</p>
    </div>
  </dialog>

  <dialog id="tile-modal">
    <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 16px;">
      <strong>Image source</strong>
      <button class="btn" onclick="tileModal.close()">Close</button>
    </header>
    <div class="modal-body">
      <div class="field">
        <label>Image file path</label>
        <input id="img-path" type="text" placeholder="map.png" />
      </div>
      <div class="field" style="display:flex; gap:8px;">
        <div style="flex:1;">
          <label>Image width (px)</label>
          <input id="img-w" type="number" min="1" placeholder="3000" />
        </div>
        <div style="flex:1;">
          <label>Image height (px)</label>
          <input id="img-h" type="number" min="1" placeholder="2000" />
        </div>
      </div>
      <div class="field" style="display:flex; gap:8px;">
        <button id="img-apply" class="btn primary">Apply</button>
        <button id="img-reset" class="btn">Default</button>
      </div>
      <p style="color:var(--subtext); font-size:12px;">Bounds are [[0,0],[height,width]]. Top left is 0,0.</p>
    </div>
  </dialog>

  <script>
    /* Storage */
    const STORAGE_KEY = 'rdr2_map_ledger_v2_image';
    const DEFAULTS = {
      categories: [],
      markerColor: '#d4af37',
      zoneColor: '#c59d2f',
      visible: {},
      collapsed: {},
      image: {
        path: 'map.jpg',
        width: 3000,
        height: 2000
      },
      features: []
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(DEFAULTS);
        const parsed = JSON.parse(raw);
        return Object.assign(structuredClone(DEFAULTS), parsed);
      } catch { return structuredClone(DEFAULTS); }
    }
    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    let currentFileHandle = null;
    let saveTimer = null;
    function queueFileSave() {
      if (!currentFileHandle) return; // fallback is localStorage only
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => { saveWorkingFile().catch(()=>{}); }, 400);
    }

    let state = loadState();

    /* UI refs */
    const helpModal = document.getElementById('help-modal');
    const tileModal = document.getElementById('tile-modal');
    const exportModal = document.getElementById('export-modal');
    const confirmReset = document.getElementById('confirm-reset');
    const catModal = document.getElementById('cat-modal');
    const itemsEl = document.getElementById('items');
    // removed current-category pills UI
    const visibilityEl = document.getElementById('visibility-list');
    const searchInput = document.getElementById('search-input');

    const markerColorEl = document.getElementById('marker-color');
    const zoneColorEl = document.getElementById('zone-color');
    if (markerColorEl) markerColorEl.value = state.markerColor || '#d4af37';
    if (zoneColorEl) zoneColorEl.value = state.zoneColor || '#c59d2f';

    document.getElementById('img-apply').onclick = () => {
      const p = document.getElementById('img-path').value.trim() || 'map.png';
      const w = parseInt(document.getElementById('img-w').value, 10);
      const h = parseInt(document.getElementById('img-h').value, 10);
      if (Number.isFinite(w) && Number.isFinite(h) && w > 0 && h > 0) {
        state.image = { path: p, width: w, height: h };
        swapImageOverlay();
        saveState();
        tileModal.close();
      }
    };
    document.getElementById('img-reset').onclick = () => {
      state.image = structuredClone(DEFAULTS.image);
      swapImageOverlay();
      saveState();
      tileModal.close();
    };

    // Image settings and category edit buttons
    document.getElementById('edit-categories').onclick = () => {
      const list = document.getElementById('cat-list');
      list.innerHTML = '';
      const targetSel = document.getElementById('cat-move-target');
      targetSel.innerHTML = '';
      state.categories.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; targetSel.appendChild(o); });
      state.categories.forEach(cat => {
        const row = document.createElement('div'); row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.gap = '8px'; row.style.justifyContent = 'space-between'; row.style.marginBottom = '6px';
        const left = document.createElement('div'); left.textContent = cat; left.style.color = 'var(--text)';
        const right = document.createElement('div');
        const del = document.createElement('button'); del.className = 'btn danger'; del.textContent = 'Delete';
        del.onclick = () => {
          const moveTo = document.getElementById('cat-move-target').value || 'General';
          if (moveTo === cat && state.categories.length > 1) { alert('Choose a different target category'); return; }
          state.features.forEach(f => { if (f.properties.category === cat) f.properties.category = moveTo; });
          state.categories = state.categories.filter(x => x !== cat);
          delete state.visible[cat];
          if (!state.categories.includes(moveTo)) { state.categories.push(moveTo); state.visible[moveTo] = true; }
          saveState(); refreshVisibility(); refreshFeatures();
          document.getElementById('edit-categories').click();
        };
        right.appendChild(del);
        row.appendChild(left); row.appendChild(right);
        list.appendChild(row);
      });
      catModal.showModal();
    };

    // Try to load bundled data once on startup if no saved features
    async function tryLoadBundledData() {
      if (state && state.features && state.features.length) return;
      try {
        const res = await fetch('rdr2-map.json', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        if (data.state) {
          state = Object.assign(structuredClone(DEFAULTS), data.state);
        } else if (data.type === 'FeatureCollection' && Array.isArray(data.features)) {
          state.features = data.features.map(f => {
            if (!f.properties) f.properties = {};
            if (!f.properties.id) f.properties.id = crypto.randomUUID();
            if (!f.properties.category) f.properties.category = 'General';
            if (!f.properties.color) f.properties.color = f.geometry.type === 'Point' ? state.markerColor : state.zoneColor;
            return f;
          });
        }
        saveState(); refreshVisibility(); refreshFeatures();
      } catch {}
    }

    // Try to load bundled data once on startup if no saved features
    async function tryLoadBundledData() {
      if (state && state.features && state.features.length) return;
      try {
        const res = await fetch('rdr2-map.json', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        if (data.state) {
          state = Object.assign(structuredClone(DEFAULTS), data.state);
        } else if (data.type === 'FeatureCollection' && Array.isArray(data.features)) {
          state.features = data.features.map(f => {
            if (!f.properties) f.properties = {};
            if (!f.properties.id) f.properties.id = crypto.randomUUID();
            if (!f.properties.category) f.properties.category = 'General';
            if (!f.properties.color) f.properties.color = f.geometry.type === 'Point' ? state.markerColor : state.zoneColor;
            return f;
          });
        }
        saveState(); refreshVisibility(); refreshFeatures();
      } catch {}
    }

    /* Map with single image overlay (CRS.Simple) */
    const map = L.map('map', {
      zoomControl: true,
      preferCanvas: true,
      crs: L.CRS.Simple,
      minZoom: -2,
      maxBoundsViscosity: 0.0,
      zoomAnimation: false,
      markerZoomAnimation: false,
      fadeAnimation: false,
      updateWhenIdle: true
    });

    let imageLayer = null;
    const AsyncImageOverlay = L.ImageOverlay.extend({
      _initImage() {
        L.ImageOverlay.prototype._initImage.call(this);
        if (this._image) {
          try { this._image.decoding = 'async'; } catch {}
          try { this._image.loading = 'eager'; } catch {}
          try { this._image.fetchPriority = 'high'; } catch {}
        }
      }
    });

    async function preferCompressedImage() {
      // If a WebP version exists, prefer it once and persist
      if (!state.image || !state.image.path || /map\.jpg$/i.test(state.image.path)) {
        try {
          const res = await fetch('map.webp', { method: 'HEAD' });
          if (res.ok) { state.image.path = 'map.webp'; saveState(); }
        } catch {}
      }
    }

    async function swapImageOverlay() {
      if (imageLayer) imageLayer.remove();
      const b = [[0, 0], [state.image.height, state.image.width]];
      await preferCompressedImage();
      imageLayer = new AsyncImageOverlay(state.image.path || 'map.jpg', b).addTo(map);
      map.setMaxBounds(b);
      map.fitBounds(b);
    }
    swapImageOverlay();

    /* Feature Layer and Draw Control */
    function esc(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => c === '&' ? '&amp;' : c === '<' ? '&lt;' : c === '>' ? '&gt;' : c === '"' ? '&quot;' : '&#39;');
    }
    function popupHtmlFor(f) {
      const p = f.properties || {};
      const title = esc(p.title || (f.geometry?.type === 'Point' ? 'Marker' : 'Zone'));
      const desc = esc(p.description || '');
      const cat = esc(p.category || 'General');
      const img = p.image ? `<img src="${esc(p.image)}" style="max-width:240px; max-height:240px; margin-top:8px; border-radius:8px; display:block;"/>` : '';
      const edit = `<div style="margin-top:8px;"><button class="btn" onclick="openEditor('${p.id}')">Edit</button></div>`;
      return `
        <div style="min-width:220px;">
          <div style="font-weight:600; color: var(--gold); margin-bottom:4px;">${title}</div>
          <div style="font-size:11px; color:var(--subtext); margin-bottom:6px;">Category: ${cat}</div>
          ${desc ? `<div style=\"white-space:pre-wrap; line-height:1.35;\">${desc}</div>` : ''}
          ${img}
          ${edit}
        </div>`;
    }
    const canvasRenderer = L.canvas({ padding: 0.5 });
    const drawnLayer = L.geoJSON({ type: 'FeatureCollection', features: [] }, {
      renderer: canvasRenderer,
      pointToLayer: (feat, latlng) => {
        const color = feat.properties?.color || state.markerColor;
        return L.circleMarker(latlng, {
          radius: 7, color: '#000', weight: 1, fillColor: color, fillOpacity: 0.95
        });
      },
      style: feat => ({ color: feat.properties?.color || state.zoneColor, weight: 2, fillOpacity: 0.25 }),
      onEachFeature: (feat, layer) => {
        layer.bindPopup(popupHtmlFor(feat));
      }
    }).addTo(map);

    // Debounced render to avoid repeated heavy redraws
    let _refreshRaf = null;
    function renderFeaturesNow() {
      drawnLayer.clearLayers();
      const visibleSet = state.visible || {};
      const filtered = state.features.filter(f => visibleSet[f.properties.category] !== false);
      filtered.forEach(f => drawnLayer.addData(f));
      refreshList();
    }
    function refreshFeatures() {
      if (_refreshRaf) return; _refreshRaf = requestAnimationFrame(() => { _refreshRaf = null; renderFeaturesNow(); });
    }

    // Removed default Leaflet Draw UI controls; using custom buttons instead

    const btnDrawMarker = document.getElementById('btn-draw-marker');
    const btnDrawPoly = document.getElementById('btn-draw-poly');
    const btnEdit = document.getElementById('btn-edit');
    const btnStop = document.getElementById('btn-stop');

    let activeHandler = null;
    function stopActive() { if (activeHandler) { activeHandler.disable(); activeHandler = null; } }

    // Pre-placement dialog for new items
    let pendingNew = null;
    btnDrawMarker.onclick = () => openNewItemDialog('Point');
    btnDrawPoly.onclick = () => openNewItemDialog('Polygon');

    // New Item dialog (pre-placement)
    const newDlg = document.createElement('dialog');
    newDlg.innerHTML = `
      <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 16px;">
        <strong>New item</strong>
        <button class="btn" id="n-close">Close</button>
      </header>
      <div class="modal-body">
        <div class="field"><label>Title</label><input type="text" id="n-title" /></div>
        <div class="field"><label>Description</label><textarea id="n-desc" rows="3"></textarea></div>
        <div class="field"><label>Image URL</label><input type="text" id="n-image" placeholder="https://... or data URL" /></div>
        <div class="field" style="display:flex; gap:8px; align-items:center;">
          <input type="file" id="n-image-file" accept="image/*" style="flex:1;" />
          <img id="n-preview" alt="preview" style="max-width:96px; max-height:64px; border-radius:6px; display:none; border:1px solid rgba(212,175,55,.2);" />
        </div>
        <div class="field" style="display:flex; gap:8px;">
          <div style="flex:1;">
            <label>Category</label>
            <select id="n-cat"></select>
          </div>
          <div style="flex:1;">
            <label>Color</label>
            <input type="color" id="n-color" />
          </div>
        </div>
        <div class="field">
          <label>Or add new category</label>
          <input type="text" id="n-newcat" placeholder="New category" />
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn primary" id="n-continue">Continue</button>
          <button class="btn" id="n-cancel">Cancel</button>
        </div>
      </div>`;
    document.body.appendChild(newDlg);

    function openNewItemDialog(kind) {
      stopActive();
      newDlg.dataset.kind = kind;
      const isPoint = kind === 'Point';
      newDlg.querySelector('#n-title').value = isPoint ? 'Marker' : 'Zone';
      newDlg.querySelector('#n-desc').value = '';
      newDlg.querySelector('#n-image').value = '';
      newDlg.querySelector('#n-newcat').value = '';
      const prev = newDlg.querySelector('#n-preview'); prev.src = ''; prev.style.display = 'none';
      const catSel = newDlg.querySelector('#n-cat');
      catSel.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
      newDlg.querySelector('#n-color').value = isPoint ? (state.markerColor || '#d4af37') : (state.zoneColor || '#c59d2f');
      newDlg.showModal();
    }

    newDlg.querySelector('#n-close').onclick = () => newDlg.close();
    newDlg.querySelector('#n-cancel').onclick = () => newDlg.close();
    newDlg.querySelector('#n-image-file').addEventListener('change', evt => {
      const file = evt.target.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const url = String(reader.result || '');
        const input = newDlg.querySelector('#n-image'); input.value = url;
        const prev = newDlg.querySelector('#n-preview'); prev.src = url; prev.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });
    newDlg.querySelector('#n-image').addEventListener('input', e => {
      const v = e.target.value.trim();
      const prev = newDlg.querySelector('#n-preview');
      if (v) { prev.src = v; prev.style.display = 'block'; } else { prev.src = ''; prev.style.display = 'none'; }
    });
    newDlg.querySelector('#n-continue').onclick = () => {
      const kind = newDlg.dataset.kind;
      const isPoint = kind === 'Point';
      const title = newDlg.querySelector('#n-title').value.trim() || (isPoint ? 'Marker' : 'Zone');
      const description = newDlg.querySelector('#n-desc').value.trim();
      const image = newDlg.querySelector('#n-image').value.trim();
      const newcat = newDlg.querySelector('#n-newcat').value.trim();
      const category = newcat || newDlg.querySelector('#n-cat').value || 'General';
      const color = newDlg.querySelector('#n-color').value || (isPoint ? state.markerColor : state.zoneColor);
      pendingNew = { title, description, image, category, color };
      // Start draw
      stopActive();
      if (isPoint) {
        activeHandler = new L.Draw.Marker(map);
      } else {
        activeHandler = new L.Draw.Polygon(map, { shapeOptions: { color } });
      }
      activeHandler.enable();
      newDlg.close();
    };
    btnEdit.onclick = () => {
      stopActive();
      activeHandler = new L.EditToolbar.Edit(map, { featureGroup: drawnLayer });
      activeHandler.enable();
    };
    btnStop.onclick = stopActive;

    map.on(L.Draw.Event.CREATED, e => {
      const layer = e.layer;
      const isPoint = layer instanceof L.Marker || layer instanceof L.CircleMarker;
      const feature = isPoint ? markerToFeature(layer) : polygonToFeature(layer);
      feature.properties.id = crypto.randomUUID();
      const defaults = {
        category: 'General',
        color: isPoint ? state.markerColor : state.zoneColor,
        title: isPoint ? 'Marker' : 'Zone',
        description: '',
        image: ''
      };
      const props = Object.assign(defaults, pendingNew || {});
      feature.properties.category = props.category;
      feature.properties.color = props.color;
      feature.properties.title = props.title;
      feature.properties.description = props.description;
      feature.properties.image = props.image || '';
      if (props.category && !state.categories.includes(props.category)) {
        state.categories.push(props.category);
        state.visible[props.category] = true;
      }
      state.features.push(feature);
      saveState(); queueFileSave();
      refreshFeatures();
      stopActive();
      pendingNew = null;
    });

    map.on('draw:edited', e => {
      const layers = e.layers;
      layers.eachLayer(layer => {
        const id = getLayerId(layer);
        if (!id) return;
        const idx = state.features.findIndex(f => f.properties.id === id);
        if (idx >= 0) state.features[idx] = toFeature(layer, state.features[idx]);
      });
      saveState(); queueFileSave();
      refreshFeatures();
    });

    map.on('draw:deleted', e => {
      const ids = [];
      e.layers.eachLayer(l => { const id = getLayerId(l); if (id) ids.push(id); });
      if (ids.length) {
        state.features = state.features.filter(f => !ids.includes(f.properties.id));
        saveState(); queueFileSave();
        refreshFeatures();
      }
    });

    /* GeoJSON helpers for CRS.Simple (pixels) */
    function toFeature(layer, prev) {
      const base = prev ? JSON.parse(JSON.stringify(prev)) : { type: 'Feature', properties: {} };
      if (layer instanceof L.Marker || layer instanceof L.CircleMarker) return markerToFeature(layer, base);
      return polygonToFeature(layer, base);
    }
    function markerToFeature(layer, base = { type: 'Feature', properties: {} }) {
      const latlng = layer.getLatLng(); // lat = y pixels, lng = x pixels
      return Object.assign(base, { geometry: { type: 'Point', coordinates: [latlng.lng, latlng.lat] } });
    }
    function polygonToFeature(layer, base = { type: 'Feature', properties: {} }) {
      const latlngs = layer.getLatLngs()[0] || [];
      const coords = latlngs.map(p => [p.lng, p.lat]);
      if (coords.length && (coords[0][0] !== coords[coords.length - 1][0] || coords[0][1] !== coords[coords.length - 1][1])) {
        coords.push(coords[0]);
      }
      return Object.assign(base, { geometry: { type: 'Polygon', coordinates: [coords] } });
    }
    function getLayerId(layer) {
      if (layer.feature?.properties?.id) return layer.feature.properties.id;
      const f = toFeature(layer);
      const str = JSON.stringify(f.geometry);
      const found = state.features.find(x => JSON.stringify(x.geometry) === str);
      return found?.properties?.id;
    }

    /* Sidebar rendering */
    // removed current-category pills rendering

    document.getElementById('add-category').onclick = () => {
      const input = document.getElementById('category-input');
      const val = input.value.trim();
      if (!val) return;
      if (!state.categories.includes(val)) {
        state.categories.push(val);
        state.visible[val] = true;
        saveState();
        refreshVisibility();
        refreshFeatures();
      }
      input.value = '';
    };

    if (markerColorEl) markerColorEl.oninput = e => { state.markerColor = e.target.value; saveState(); };
    if (zoneColorEl) zoneColorEl.oninput = e => { state.zoneColor = e.target.value; saveState(); };
    if (searchInput) {
      searchInput.value = state.search || '';
      searchInput.oninput = e => { state.search = e.target.value; refreshList(); };
      searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          const q = (searchInput.value || '').trim().toLowerCase();
          if (!q) return;
          const first = state.features.find(f => {
            const t = String(f.properties?.title || (f.geometry?.type === 'Point' ? 'Marker' : 'Zone')).toLowerCase();
            const d = String(f.properties?.description || '').toLowerCase();
            const c = String(f.properties?.category || 'General').toLowerCase();
            return t.includes(q) || d.includes(q) || c.includes(q);
          });
          if (first) flyToFeature(first.properties.id);
        }
      });
    }

    document.addEventListener('keydown', e => {
      if (!searchInput) return;
      const activeTag = document.activeElement?.tagName?.toLowerCase();
      const isTyping = activeTag === 'input' || activeTag === 'textarea';
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault(); searchInput.focus(); searchInput.select();
      } else if (!isTyping && e.key === '/') {
        e.preventDefault(); searchInput.focus();
      }
    });

    function refreshVisibility() {
      visibilityEl.innerHTML = '';
      state.categories.forEach(cat => {
        const b = document.createElement('button');
        b.className = 'pill' + ((state.visible[cat] !== false) ? ' active' : '');
        b.textContent = cat;
        b.onclick = () => { state.visible[cat] = !(state.visible[cat] !== false); saveState(); refreshVisibility(); refreshFeatures(); };
        visibilityEl.appendChild(b);
      });
    }
    refreshVisibility();

    function refreshList() {
      itemsEl.innerHTML = '';
      const byCat = new Map();
      const q = String(state.search || '').trim().toLowerCase();
      state.categories.forEach(c => byCat.set(c, []));
      state.features.forEach(f => {
        const c = f.properties.category || 'General';
        if (!byCat.has(c)) byCat.set(c, []);
        const t = String(f.properties?.title || (f.geometry?.type === 'Point' ? 'Marker' : 'Zone')).toLowerCase();
        const d = String(f.properties?.description || '').toLowerCase();
        const cat = String(f.properties?.category || 'General').toLowerCase();
        const match = !q || t.includes(q) || d.includes(q) || cat.includes(q);
        if (match) byCat.get(c).push(f);
      });

      state.categories.forEach(catName => {
        const list = byCat.get(catName) || [];
        if (!list.length) return;
        const group = document.createElement('div'); group.className = 'group' + (state.collapsed?.[catName] ? ' collapsed' : '');
        const header = document.createElement('div'); header.className = 'group-header';
          const chev = document.createElement('span'); chev.className = 'chev'; chev.textContent = '▾';
        const title = document.createElement('div'); title.textContent = catName;
        const count = document.createElement('div'); count.className = 'count'; count.textContent = String(list.length);
        header.appendChild(chev); header.appendChild(title); header.appendChild(count);
        header.onclick = () => { state.collapsed[catName] = !state.collapsed[catName]; saveState(); refreshList(); };
        group.appendChild(header);

        const container = document.createElement('div'); container.className = 'group-items';
        list.forEach(f => {
          const hidden = state.visible[f.properties.category] === false;
          const row = document.createElement('div');
          row.className = 'item';
          const left = document.createElement('div');
          left.className = 'meta';
          const dot = document.createElement('span'); dot.className = 'dot'; dot.style.background = f.properties.color || '#aaa';
          const title = document.createElement('div'); title.className = 'title'; title.textContent = f.properties.title || (f.geometry.type === 'Point' ? 'Marker' : 'Zone');
          const cat = document.createElement('div'); cat.className = 'cat'; cat.textContent = f.properties.category;
          left.appendChild(dot); left.appendChild(title); left.appendChild(cat);
          const right = document.createElement('div');
          const moreBtn = document.createElement('button'); moreBtn.className = 'btn'; moreBtn.textContent = '⋯';
          moreBtn.setAttribute('aria-haspopup', 'true');
          moreBtn.style.minWidth = '36px';
          const menu = document.createElement('div');
          menu.style.position = 'fixed';
          menu.style.background = '#0f0f11';
          menu.style.border = '1px solid rgba(212,175,55,.25)';
          menu.style.borderRadius = '8px';
          menu.style.boxShadow = '0 8px 20px rgba(0,0,0,.5)';
          menu.style.padding = '6px';
          menu.style.display = 'none';
          menu.style.zIndex = '10050';
          const mkItem = (label, cls, handler) => {
            const b = document.createElement('button'); b.className = 'btn ' + (cls||''); b.textContent = label; b.style.display = 'block'; b.style.width = '100%'; b.style.textAlign = 'left'; b.style.margin = '4px 0'; b.onclick = () => { hideMenu(); handler(); };
            return b;
          };
          const openBtn = mkItem('Edit', '', () => openEditor(f.properties.id));
          const dupBtn = mkItem('Duplicate', '', () => duplicateFeature(f.properties.id));
          const flyBtn = mkItem('Go', 'ghost', () => flyToFeature(f.properties.id));
          const delBtn = mkItem('Delete', 'danger', () => deleteFeature(f.properties.id));
          menu.appendChild(openBtn); menu.appendChild(dupBtn); menu.appendChild(flyBtn); menu.appendChild(delBtn);
          function hideMenu() { menu.style.display = 'none'; document.removeEventListener('click', onDoc); }
          function onDoc(ev) { if (!menu.contains(ev.target) && ev.target !== moreBtn) hideMenu(); }
          moreBtn.onclick = (ev) => {
            ev.stopPropagation();
            const rect = moreBtn.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 6) + 'px';
            menu.style.display = 'block';
            document.addEventListener('click', onDoc);
          };
          right.style.position = 'relative';
          right.appendChild(moreBtn);
          document.body.appendChild(menu);
          row.appendChild(left); row.appendChild(right);
          if (hidden) row.style.opacity = .45;

          container.appendChild(row);
        });
        group.appendChild(container);
        itemsEl.appendChild(group);
      });
    }

    function flyToFeature(id) {
      const f = state.features.find(x => x.properties.id === id);
      if (!f) return;
      if (f.geometry.type === 'Point') {
        const [x, y] = f.geometry.coordinates;
        map.flyTo([y, x], 2);
      } else if (f.geometry.type === 'Polygon') {
        const latlngs = f.geometry.coordinates[0].map(([x, y]) => [y, x]);
        const bounds = L.latLngBounds(latlngs);
        map.flyToBounds(bounds, { padding: [40, 40] });
      }
    }

    function deleteFeature(id) {
      const idx = state.features.findIndex(x => x.properties.id === id);
      if (idx >= 0) {
        state.features.splice(idx, 1);
        saveState(); refreshFeatures();
      }
    }

    function duplicateFeature(id) {
      const f = state.features.find(x => x.properties.id === id);
      if (!f) return;
      const isPoint = f.geometry?.type === 'Point';
      const title = f.properties?.title || (isPoint ? 'Marker' : 'Zone');
      const description = f.properties?.description || '';
      const image = f.properties?.image || '';
      const category = f.properties?.category || 'General';
      const color = f.properties?.color || (isPoint ? state.markerColor : state.zoneColor);
      pendingNew = { title, description, image, category, color };
      stopActive();
      if (isPoint) {
        activeHandler = new L.Draw.Marker(map);
      } else {
        activeHandler = new L.Draw.Polygon(map, { shapeOptions: { color } });
      }
      activeHandler.enable();
    }

    /* Editor modal */
    const editor = document.createElement('dialog');
    editor.innerHTML = `
      <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 16px;">
        <strong>Edit item</strong>
        <button class="btn" id="editor-close">Close</button>
      </header>
      <div class="modal-body">
        <div class="field"><label>Title</label><input type="text" id="e-title" /></div>
        <div class="field"><label>Description</label><textarea id="e-desc" rows="3"></textarea></div>
        <div class="field"><label>Image URL</label><input type="text" id="e-image" placeholder="https://... or data URL" /></div>
        <div class="field" style="display:flex; gap:8px; align-items:center;">
          <input type="file" id="e-image-file" accept="image/*" style="flex:1;" />
          <img id="e-preview" alt="preview" style="max-width:96px; max-height:64px; border-radius:6px; display:none; border:1px solid rgba(212,175,55,.2);" />
        </div>
        <div class="field" style="display:flex; gap:8px;">
          <div style="flex:1;">
            <label>Category</label>
            <select id="e-cat"></select>
          </div>
          <div style="flex:1;">
            <label>Color</label>
            <input type="color" id="e-color" />
          </div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn primary" id="e-apply">Apply</button>
          <button class="btn" id="e-center">Center on map</button>
        </div>
      </div>`;
    document.body.appendChild(editor);

    editor.querySelector('#editor-close').onclick = () => editor.close();

    function openEditor(id) {
      const f = state.features.find(x => x.properties.id === id);
      if (!f) return;
      editor.dataset.id = id;
      editor.querySelector('#e-title').value = f.properties.title || '';
      editor.querySelector('#e-desc').value = f.properties.description || '';
      editor.querySelector('#e-image').value = f.properties.image || '';
      const prev = editor.querySelector('#e-preview');
      if (f.properties.image) { prev.src = f.properties.image; prev.style.display = 'block'; } else { prev.src = ''; prev.style.display = 'none'; }
      const catSel = editor.querySelector('#e-cat');
      catSel.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
      catSel.value = f.properties.category;
      editor.querySelector('#e-color').value = f.properties.color || '#d4af37';
      editor.showModal();
    }

    editor.querySelector('#e-apply').onclick = () => {
      const id = editor.dataset.id;
      const idx = state.features.findIndex(x => x.properties.id === id);
      if (idx < 0) return;
      state.features[idx].properties.title = editor.querySelector('#e-title').value.trim();
      state.features[idx].properties.description = editor.querySelector('#e-desc').value.trim();
      state.features[idx].properties.image = editor.querySelector('#e-image').value.trim();
      state.features[idx].properties.category = editor.querySelector('#e-cat').value;
      state.features[idx].properties.color = editor.querySelector('#e-color').value;
      saveState(); queueFileSave(); refreshFeatures(); editor.close();
    };
    editor.querySelector('#e-center').onclick = () => {
      const id = editor.dataset.id; editor.close(); flyToFeature(id);
    };

    // Image file -> data URL
    editor.querySelector('#e-image-file').addEventListener('change', evt => {
      const file = evt.target.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const url = String(reader.result || '');
        const input = editor.querySelector('#e-image');
        input.value = url;
        const prev = editor.querySelector('#e-preview');
        prev.src = url; prev.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    // Keep preview in sync when typing URL
    editor.querySelector('#e-image').addEventListener('input', e => {
      const v = e.target.value.trim();
      const prev = editor.querySelector('#e-preview');
      if (v) { prev.src = v; prev.style.display = 'block'; } else { prev.src = ''; prev.style.display = 'none'; }
    });

    /* Export / Import / Reset */
    // Export flow with selection
    function refreshExportModal() {
      // populate items
      const sel = document.getElementById('ex-item');
      sel.innerHTML = state.features.map(f => `<option value="${f.properties.id}">${(f.properties.title|| (f.geometry.type==='Point'?'Marker':'Zone'))} - ${f.properties.category}</option>`).join('');
      const radios = exportModal.querySelectorAll('input[name="ex-scope"]');
      const wrap = document.getElementById('ex-item-wrap');
      radios.forEach(r => r.onchange = () => { wrap.style.display = (exportModal.querySelector('input[name="ex-scope"]:checked').value === 'single') ? 'block' : 'none'; });
      wrap.style.display = (exportModal.querySelector('input[name="ex-scope"]:checked').value === 'single') ? 'block' : 'none';
    }
    document.getElementById('export').onclick = () => { refreshExportModal(); exportModal.showModal(); };
    document.getElementById('ex-do').onclick = () => {
      const scope = exportModal.querySelector('input[name="ex-scope"]:checked').value;
      let payload, filename;
      if (scope === 'single') {
        const id = document.getElementById('ex-item').value;
        const f = state.features.find(x => x.properties.id === id);
        if (!f) { alert('No item selected'); return; }
        payload = f; filename = `rdr2-item-${(f.properties.title||'item').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||'item'}.geojson`;
      } else {
        payload = { meta: { app: 'rdr2-map-ledger', version: 2, exportedAt: new Date().toISOString() }, state };
        filename = 'rdr2-map.json';
      }
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      exportModal.close();
    };

    // File System Access API integration
    function makeAllPayload() {
      return { meta: { app: 'rdr2-map-ledger', version: 2, exportedAt: new Date().toISOString() }, state };
    }
    async function openWorkingFile() {
      try {
        if (!window.showOpenFilePicker) { alert('Your browser does not support opening files directly. Use Import instead.'); return; }
        const [handle] = await window.showOpenFilePicker({
          multiple: false,
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
        });
        currentFileHandle = handle;
        const file = await handle.getFile();
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.state) {
          state = Object.assign(structuredClone(DEFAULTS), data.state);
        } else if (data.type === 'FeatureCollection' && Array.isArray(data.features)) {
          state.features = data.features.map(f => {
            if (!f.properties) f.properties = {};
            if (!f.properties.id) f.properties.id = crypto.randomUUID();
            if (!f.properties.category) f.properties.category = 'General';
            if (!f.properties.color) f.properties.color = f.geometry.type === 'Point' ? state.markerColor : state.zoneColor;
            return f;
          });
        }
        saveState(); refreshVisibility(); refreshFeatures(); swapImageOverlay();
      } catch (e) { console.warn(e); }
    }
    async function saveWorkingFile(forcePicker = false) {
      try {
        if (!currentFileHandle || forcePicker) {
          if (!window.showSaveFilePicker) { // fallback to download
            const payload = makeAllPayload();
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'rdr2-map.json'; a.click();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
            return;
          }
          currentFileHandle = await window.showSaveFilePicker({ suggestedName: 'rdr2-map.json', types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }] });
        }
        const writable = await currentFileHandle.createWritable();
        await writable.write(JSON.stringify(makeAllPayload(), null, 2));
        await writable.close();
      } catch (e) { console.warn(e); }
    }


    document.getElementById('import-file').onchange = evt => {
      const file = evt.target.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.state) {
            state = Object.assign(structuredClone(DEFAULTS), data.state);
            swapImageOverlay();
          } else if (data.type === 'FeatureCollection' && Array.isArray(data.features)) {
            state.features = data.features.map(f => {
              if (!f.properties) f.properties = {};
              if (!f.properties.id) f.properties.id = crypto.randomUUID();
              if (!f.properties.category) f.properties.category = 'General';
              if (!f.properties.color) f.properties.color = f.geometry.type === 'Point' ? state.markerColor : state.zoneColor;
              return f;
            });
          }
          saveState(); queueFileSave(); refreshVisibility(); refreshFeatures();
        } catch { alert('Invalid file'); }
        evt.target.value = '';
      };
      reader.readAsText(file);
    };

    // Custom Reset confirm
    document.getElementById('reset').onclick = () => { document.getElementById('confirm-reset').showModal(); };
    document.getElementById('confirm-reset-yes').onclick = () => {
      state = structuredClone(DEFAULTS);
      saveState(); queueFileSave(); refreshVisibility(); refreshFeatures(); swapImageOverlay();
      document.getElementById('confirm-reset').close();
    };

    /* Start */
    tryLoadBundledData().finally(() => refreshFeatures());
  </script>
</body>
</html>
